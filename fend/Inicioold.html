//<script type="text/jsx">
  let creadopor;
  var n, id;
  const fechaCreado = new Date().toLocaleString() + " ";
  function Inicio() {

    const inicio = {
      id: " ",
      ci: " ",
      nombre: " ",
      empresa: " ",
      estado: " ",
      TipoServicio: " ",
    }

    const [dataSource, setdataSource] = useState([])
    const [sdato, setSdato] = useState(" ")
    const [disa, setDisa] = useState(true)
    const [dataid, setDataid] = useState(inicio);
    const [hide, seHide] = useState(false)

   useEffect(listar, [])

     async function cantRow() {
      await google.script.run.withSuccessHandler(res => {
            n = res;
            id = "ID-" + (Math.round(n) + 1);
            save()
      }).cantRows()
    }

    async function listar() {
      await User()
      await google.script.run.withSuccessHandler(res => {
          const respuest = JSON.parse(res);
          let arreglo = [];
          respuest
              .sort((a, b) =>  b.fechacreado > a.fechacreado ? 1 : -1)
              .map(data => {
              //if(data.creadoPor === creadopor)
              arreglo.push({...data})
          })
          setdataSource(arreglo)
         }).listarUser();
  }

    async function save() {
      const estado = "Creado"
      notificacionGuardando("Guardando Registro");
        await google.script.run.withSuccessHandler(resp => {
          listar()
          notificacionTareaTerminada(resp.titulo, resp.descripcion);
        }).save(JSON.stringify({ id, creadopor, fechaCreado, ...sdato, estado } ));
  }

  const checkData = (e) => {
    const { name, value } = e.target;
    if(dataid.id != " ") {
      setDataid({...dataid, [name]: value})
    } else { setSdato({...sdato, [name]: value}); setDisa(false) }

      //if(e.target.name === "FechaServicio") setDisa(false)
  }

  async function User() {
    await google.script.run.withSuccessHandler(res => {
      creadopor = (res)
      console.log("creado " + creadopor)
    }).perfil();
  }

  const bcolor = (kfalta) => {
    if(kfalta === "Creado") return ('#FFBB5C')
     else if(kfalta === "Completado") return ('#435334')
   }

  function handCheck(idt) {
    const rfind = dataSource.find((dat) => dat.id === idt)
        setDataid({
            id : rfind.id,
            fechacreado: rfind.fechacreado,
            creadoPor: rfind.creadoPor,
            ci: rfind.ci,
            nombre: rfind.nombre,
            empresa: rfind.empresa,
            modificado: rfind.modificado,
            estado: rfind.estado,
            gthadmin: rfind.gthadmin
        });listar();

        if(rfind.estado === "Completado") seHide(true)
        else seHide(false)
  }

   const updateData = async () => {
    console.log(dataid.id)
    notificacionGuardando("Actualizando Registro");
    await google.script.run.withSuccessHandler(resp => {
      notificacionTareaTerminada(resp.titulo, resp.descripcion);
       listar()
       setDataid(inicio)
   }).updateTicket(dataid.id, dataid.ci, dataid.nombre, dataid.empresa, dataid.estado, dataid.gthadmin, dataid.modificado )
  }

  
  return (
      <div className="container-sm rounded shadow" style={{"marginTop": '2rem'}}>
        <div>
          <h2 className="p-2 bg-primary-subtle bg-opacity-10 fst-italic">Registro ARI</h2>
        </div>
        <div className="container-sm rounded shadow-sm" style={{"marginTop": '2rem'}}>
          <h4>Reportes Creados y Estado: {creadopor}</h4>
          <div>
            <div className="modal fade" id="ApprovarModel" aria-hidden="true" aria-labelledby="ApprovarModelLabel">
                <div className="modal-dialog modal-dialog-centered">
                    <div className="modal-content">
                    <div className="modal-header bg-dark bg-gradient">
                        <h1 className="modal-title fs-5 text-white" id="ApprovarModelLabel">Por Favor Ingrese Los Datos</h1>
                        <button type="button" className="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div className="modal-body">
                      <form className="needs-validation">
                        <div className="row g-4">
                          <div className="row mt-3">
                            <label className="form-label">Ingrese su CI</label>
                            <input type="text" className="form-control" name="ci" required onChange={checkData} value={dataid.ci}></input>
                          </div>
                          <div className="row mt-3">
                            <label className="form-label">Nombres y Apellidos</label>
                            <input type="text" className="form-control" name="nombre" required onChange={checkData} value={dataid.nombre}></input>
                          </div>
                        </div>
                        <div className="row g-4 mt-2">
                       
                        <div className="row mt-3">
                          <label className="form-label">Empresa</label>
                          <input type="text" className="form-control" name="desde" required onChange={checkData} value={dataid.empresa}></input>
                        </div>
                     </div>
                      <div className="row g-4 mt-2 border-start border-primary bg-light bg-gradient">
                        <div className="col-6" hidden={hide ? false : true}>
                          <label className="form-label">Asignado</label>
                          <label className="form-control" name="AsignadoPor">{dataid.gthadmin}</label>
                        </div>
                      </div>
                      </form>
                    </div>
                    <div className="modal-footer" hidden={hide ? true : false }>
                        <button type="button" className="btn btn-primary" data-bs-dismiss="modal" onClick={() => {dataid.id != " " ? updateData() : cantRow()}}>Actualizar</button>
                    </div>
                    </div>
                </div>
            </div>
          </div>
          <div>
            <div className="modal fade" id="CrearModel" aria-hidden="true" aria-labelledby="CrearModelLabel">
                <div className="modal-dialog modal-dialog-centered">
                    <div className="modal-content">
                    <div className="modal-header bg-dark bg-gradient">
                        <h1 className="modal-title fs-5 text-white" id="CrearModelLabel">Por Favor Ingrese Los Datos</h1>
                        <button type="button" className="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div className="modal-body">
                      <form className="needs-validation">
                        <div className="row g-4">
                          <div className="row mt-3">
                            <label className="form-label">Ingrese su CI: "11111111"</label>
                            <input type="text" className="form-control" name="ci" required onChange={checkData}></input>
                          </div>
                          <div className="row mt-3">
                            <label className="form-label">Nombres y Apellidos</label>
                            <input type="text" className="form-control" name="nombre" required onChange={checkData}></input>
                          </div>
                          
                        </div>
                        <div className="row mt-3">
                          <label className="form-label">Empresa</label>
                          <input type="text" className="form-control" name="empresa" required onChange={checkData}></input>
                        </div>
                      </form>
                    </div>
                    <div className="modal-footer" hidden={hide ? true : false }>
                        <button type="button" className="btn btn-primary" data-bs-dismiss="modal" onClick={() => {dataid.id != " " ? updateData() : cantRow()}} disabled = {disa}>Salvar</button>
                    </div>
                    </div>
                </div>
            </div>
            <button className="btn btn-primary" data-bs-target="#CrearModel" data-bs-toggle="modal">Cargar</button>
          </div>
          <table className="table table-striped table-hover">
            <thead className="bg-secondary text-white text-center">
              <tr>
                <th className="p-2">ID</th>
                <th className="p-2">Fecha Creado</th>
                <th className="p-2">Empresa</th>
                <th className="p-2">Nombres y Apellidos</th>
                <th className="p-2">Editar</th>
                <th className="p-2">Estado</th>
              </tr>
            </thead>
            <tbody>
              {dataSource.map((datos) =>
               <tr key={datos.id}>
               <td className="text-center" >{datos.id}</td>
               <td className="text-center">{dayjs(datos.fechacreado).format("DD/MM/YYYY")}</td>
               <td>{datos.empresa}</td>
               <td>{datos.nombre}</td>
               <td><button className="btn-sm bg-primary text-white" data-bs-target="#ApprovarModel" data-bs-toggle="modal" onClick={() => {handCheck(datos.id)}}>Edit</button></td>
               <td className="badge rounded-pill text-white fs-8 mt-2" style={{"backgroundColor": bcolor(datos.estado)}}>{datos.estado}</td>
             </tr>
              )}
            </tbody>
          </table>
        </div>
        <div><hr/></div>
      </div>
    )
  }
  //</script>
